@model Firebase.Models.Servicio
@{
    var edit = Model != null && !string.IsNullOrWhiteSpace(Model.Id);
    string formAction = edit ? Url.Action("ActualizarServicioAjax", "Servicio") : Url.Action("CrearServicioAjax", "Servicio");
    string submitText = edit ? "Guardar" : "Registrar";
    string clearText = edit ? "Cancelar" : "Limpiar Campos";
}
<form id="servicio-form" data-edit="@edit" method="post" action="@formAction" onsubmit="return submitServicioAjax(this);">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" id="Id" value="@(Model?.Id)" />
    <input type="hidden" name="Estado" value="@(Model?.Estado ?? "Activo")" />

    <div class="grid gap-4 m-4 grid-cols-5">
        <div>
            <label for="Nombre" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre <span class="text-red-600">*</span></label>
            <input type="text" name="Nombre" id="Nombre"
                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                   placeholder="Nombre del servicio"
                   value="@(Model?.Nombre)"
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                   title="Solo se permiten letras y espacios. Mínimo 3 caracteres."
                   minlength="3"
                   required>
            <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">Mínimo 3 caracteres</p>
            <span asp-validation-for="Nombre" class="text-red-600 text-xs"></span>
        </div>
        <div>
            <label for="Precio" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Precio <span class="text-red-600">*</span></label>
            <input type="number" name="Precio" id="Precio"
                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                   placeholder="Precio del servicio"
                   value="@(Model?.Precio.ToString(System.Globalization.CultureInfo.InvariantCulture))"
                   min="0" step="100" required />
            <span asp-validation-for="Precio" class="text-red-600 text-xs"></span>
        </div>
        <div class="col-span-2">
            <label for="Tipo" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Servicio <span class="text-red-600">*</span></label>
            <div class="flex">
                <select name="Tipo" id="Tipo" 
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 @(edit ? "cursor-not-allowed opacity-60" : "")" 
                 required
                        @(edit ? "disabled" : "")>
                    @foreach (var tipo in (ViewBag.TiposServicio as List<string>) ?? new List<string>())
                    {
         if (Model?.Tipo != null && string.Equals(Model.Tipo, tipo, StringComparison.OrdinalIgnoreCase))
          {
   <option value="@tipo" selected>@tipo</option>
   }
                else
                {
       <option value="@tipo">@tipo</option>
        }
       }
                </select>
                <button type="button" data-modal-target="defaultModal" data-modal-toggle="defaultModal" 
                        class="ml-2 px-1 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
                 @(edit ? "disabled" : "")>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                </button>
                <button type="button" data-modal-target="eliminarTipoModal" data-modal-toggle="eliminarTipoModal" 
       class="ml-2 px-1 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
     @(edit ? "disabled" : "")>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                </button>
            </div>
            @if (edit)
            {
    <!-- Hidden input para enviar el valor cuando está disabled -->
        <input type="hidden" name="Tipo" value="@Model.Tipo" />
   <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
            <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
  </svg>
    No se puede cambiar el tipo de servicio al editar
        </p>
    }
  <span asp-validation-for="Tipo" class="text-red-600 text-xs"></span>
        </div>
        <!-- Tipo de Vehículo -->
        <div>
            <label for="TipoVehiculo" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Vehículo <span class="text-red-600">*</span></label>
            <div class="flex">
                <select name="TipoVehiculo" id="TipoVehiculo"
                        class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 @(edit ? "cursor-not-allowed opacity-60" : "")"
                        required
                        @(edit ? "disabled" : "")>
                    @foreach (var tipo in (ViewBag.TodosLosTiposVehiculo as List<string>) ?? new List<string>())
                    {
                        if (Model?.TipoVehiculo != null && string.Equals(Model.TipoVehiculo, tipo, StringComparison.OrdinalIgnoreCase))
                        {
                            <option value="@tipo" selected>@tipo</option>
                        }
                        else
                        {
                            <option value="@tipo">@tipo</option>
                        }
                    }
                </select>
                <button type="button" data-modal-target="tipoVehiculoModal" data-modal-toggle="tipoVehiculoModal"
                        class="ml-2 px-1 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
                        @(edit ? "disabled" : "")>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                </button>
                <button type="button" data-modal-target="eliminarTipoVehiculoModal" data-modal-toggle="eliminarTipoVehiculoModal"
                        class="ml-2 px-1 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
                        @(edit ? "disabled" : "")>
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                </button>
            </div>
            @if (edit)
            {
                <!-- Hidden input para enviar el valor cuando está disabled -->
                <input type="hidden" name="TipoVehiculo" value="@Model.TipoVehiculo" />
                <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">
                    <svg class="w-3 h-3 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" />
                    </svg>
                    No se puede cambiar el tipo de vehículo al editar un servicio
                </p>
            }
            <span asp-validation-for="TipoVehiculo" class="text-red-600 text-xs"></span>
        </div>
        <div>
            <label for="TiempoEstimado" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
        Tiempo Estimado <span class="text-red-600">*</span>
    @if (Model?.TiempoEstimado >= 60)
{
            var horas = (Model.TiempoEstimado / 60.0).ToString("0.##");
   <span class="text-gray-600 dark:text-gray-400">(@horas hs = @Model.TiempoEstimado min)</span>
 }
    else
      {
     <span class="text-gray-600 dark:text-gray-400">(minutos)</span>
 }
   </label>
       <input type="number" name="TiempoEstimado" id="TiempoEstimado"
                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                   placeholder="Tiempo estimado en minutos"
                   value="@(Model?.TiempoEstimado == 0 ? "" : Model?.TiempoEstimado.ToString())"
                   min="1" required />
            <span asp-validation-for="TiempoEstimado" class="text-red-600 text-xs"></span>
        </div>
        <div>
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Etapas del Servicio</label>
            <div class="flex items-center gap-2">
                <span class="text-sm text-gray-700 dark:text-gray-300">Cantidad de etapas: <span id="etapas-count">@(Model?.Etapas?.Count ?? 0)</span></span>
                <button type="button" onclick="openEtapasModal()" class="px-2 py-1 text-sm text-white bg-blue-600 rounded hover:bg-blue-700 transition-colors">
                    <svg class="w-4 h-4 inline" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 12.75a.75.75 0 110-1.5.75.75 0 010 1.5zM12 18.75a.75.75 0 110-1.5.75.75 0 010 1.5z"></path>
                    </svg>
                </button>
            </div>
            @{
                var etapasJson = Model?.Etapas != null && Model.Etapas.Any() 
                    ? System.Text.Json.JsonSerializer.Serialize(Model.Etapas)
                    : "[]";
            }
            <input type="hidden" id="etapas-json" name="EtapasJson" value='@etapasJson' />
        </div>
        <div class="col-span-3">
            <label for="Descripcion" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Descripción <span class="text-red-600">*</span></label>
            <textarea id="Descripcion" name="Descripcion" rows="1" style="min-height: 2.5rem; overflow-y: hidden;" oninput="autoGrow(this)" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-primary-500 focus:border-primary-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500" placeholder="Descripción del servicio" required>@(Model?.Descripcion)</textarea>
            <span asp-validation-for="Descripcion" class="text-red-600 text-xs"></span>
        </div>
    </div>
    <div class="flex justify-end m-4 gap-2">
        <button type="submit" id="submit-button" class="text-white inline-flex items-center bg-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-900 font-medium rounded-lg text-sm px-2 py-1 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-8 text-white-500 dark:text-white-400">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
            </svg>
            @submitText
        </button>
        <button type="button" id="clear-button" class="text-white inline-flex items-center bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-900 font-medium rounded-lg text-sm px-2 py-1 text-center" onclick="@(edit ? "loadServicioForm(null)" : "document.getElementById('servicio-form').reset()")">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-8 text-white-500 dark:text-white-400">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
            </svg>
            @clearText
        </button>
    </div>
    <!-- Summary (se mostrará vía JS si tiene contenido) -->
    <div id="servicio-validation-summary" asp-validation-summary="All"
         class="hidden p-4 mt-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"></div>
    <!-- Mensajes AJAX (éxito / error general) -->
    <div id="ajax-form-messages" class="mb-4"></div>
</form>