@model Firebase.Models.Cliente
@{
    var edit = Model != null && !string.IsNullOrWhiteSpace(Model.Id);
    string formAction = edit ? Url.Action("ActualizarClienteAjax", "Cliente") : Url.Action("CrearClienteAjax", "Cliente");
    string submitText = edit ? "Guardar" : "Registrar";
    string clearText = edit ? "Cancelar" : "Limpiar Campos";
}
<form id="cliente-form" data-edit="@edit" method="post" action="@formAction" onsubmit="return submitClienteAjax(this);">
    @Html.AntiForgeryToken()
    <input type="hidden" name="Id" id="Id" value="@(Model?.Id)" />

    <div class="grid gap-4 m-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-4">
        <div class="grid grid-cols-2">
            <!-- Tipo de Documento -->
            <div>
                <label for="TipoDocumento" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Tipo de Documento</label>
                <div class="flex">
                    <select name="TipoDocumento" id="TipoDocumento"
                            class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 @(edit ? "cursor-not-allowed opacity-60" : "")"
                            required @(edit ? "disabled" : "")>
                        <option value="">Seleccione...</option>
                        @foreach (var tipo in (ViewBag.TiposDocumento as List<string>) ?? new List<string>())
                        {
                            if (Model?.TipoDocumento != null && string.Equals(Model.TipoDocumento, tipo, StringComparison.OrdinalIgnoreCase))
                            {
                                <option value="@tipo" selected>@tipo</option>
                            }
                            else
                            {
                                <option value="@tipo">@tipo</option>
                            }
                        }
                    </select>
                    <button type="button" data-modal-target="tipoDocumentoModal" data-modal-toggle="tipoDocumentoModal"
                            class="ml-2 px-1 text-white bg-blue-600 rounded-lg hover:bg-blue-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
                            @(edit ? "disabled" : "")>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
                    </button>
                    <button type="button" data-modal-target="eliminarTipoDocumentoModal" data-modal-toggle="eliminarTipoDocumentoModal"
                            class="ml-2 px-1 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors @(edit ? "opacity-50 cursor-not-allowed" : "")"
                            @(edit ? "disabled" : "")>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                    </button>
                </div>
                @if (edit)
                {
                    <input type="hidden" name="TipoDocumento" value="@Model.TipoDocumento" />
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">No editable</p>
                }
                <span asp-validation-for="TipoDocumento" class="text-red-600 text-xs"></span>
            </div>

            <!-- Número de Documento -->
            <div class="pl-2">
                <label for="NumeroDocumento" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Número de Documento</label>
                <input type="text" name="NumeroDocumento" id="NumeroDocumento"
                       class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500 @(edit ? "cursor-not-allowed opacity-60" : "")"
                       placeholder="Ingrese número"
                       value="@(Model?.NumeroDocumento)"
                       pattern="[0-9]+"
                       title="Solo números"
                       required @(edit ? "readonly" : "")>
                @if (edit)
                {
                    <p class="mt-1 text-xs text-gray-500 dark:text-gray-400">No editable</p>
                }
                <span asp-validation-for="NumeroDocumento" class="text-red-600 text-xs"></span>
            </div>
        </div>
        <!-- Nombre -->
        <div>
            <label for="Nombre" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre</label>
            <input type="text" name="Nombre" id="Nombre"
                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                   placeholder="Nombre"
                   value="@(Model?.Nombre)"
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                   title="Solo letras y espacios"
                   required>
            <span asp-validation-for="Nombre" class="text-red-600 text-xs"></span>
        </div>

        <!-- Apellido -->
        <div>
            <label for="Apellido" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Apellido</label>
            <input type="text" name="Apellido" id="Apellido"
                   class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                   placeholder="Apellido"
                   value="@(Model?.Apellido)"
                   pattern="[a-zA-ZáéíóúÁÉÍÓÚñÑ\s]+"
                   title="Solo letras y espacios"
                   required>
            <span asp-validation-for="Apellido" class="text-red-600 text-xs"></span>
        </div>
        <div class="col-span-3">
            <div class="grid grid-cols-2">
                <!-- Teléfono -->
                <div>
                    <label for="Telefono" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Teléfono</label>
                    <input type="tel" name="Telefono" id="Telefono"
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                           placeholder="Teléfono"
                           value="@(Model?.Telefono)"
                           required>
                    <span asp-validation-for="Telefono" class="text-red-600 text-xs"></span>
                </div>

                <!-- Email -->
                <div class="pl-2">
                    <label for="Email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label>
                    <input type="email" name="Email" id="Email"
                           class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500"
                           placeholder="Email"
                           value="@(Model?.Email)"
                           required>
                    <span asp-validation-for="Email" class="text-red-600 text-xs"></span>
                </div>
            </div>
        </div>
        <!-- Vehículos Asociados (Selector estilo paquetes) -->
        <div class="col-span-6">
            <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Vehículos Asociados (mínimo 1) <span class="text-red-600">*</span></label>

            <!-- Input oculto para almacenar IDs -->
            <input type="hidden" id="VehiculosIdsData" value="@(Model != null && Model.VehiculosIds != null ? string.Join(",", Model.VehiculosIds) : "")" />

            <div class="bg-gray-50 border border-gray-300 rounded-lg p-3 dark:bg-gray-700 dark:border-gray-600">
                <!-- Nueva interfaz de selección (como paquetes) -->
                <div class="flex gap-2 mb-3">
                    <!-- Dropdown filtrable de vehículos -->
                    <div class="flex-1 relative">
                        <input type="text"
                               id="vehiculo-search"
                               placeholder="Buscar vehículo por patente, marca o modelo..."
                               class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white"
                               autocomplete="off"
                               onfocus="showVehiculoDropdown()"
                               oninput="filterVehiculosDropdown(this.value)" />

                        <!-- Dropdown de vehículos -->
                        <div id="vehiculo-dropdown"
                             class="hidden absolute z-10 w-full mt-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg shadow-lg max-h-80 overflow-y-auto">
                            <div id="vehiculo-dropdown-content" class="p-2">
                                <!-- Los vehículos se renderizan aquí dinámicamente -->
                            </div>
                        </div>
                    </div>

                    <!-- Botón Agregar -->
                    <button type="button"
                            onclick="agregarVehiculoSeleccionado()"
                            id="btn-agregar-vehiculo"
                            class="text-white bg-blue-600 hover:bg-blue-700 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 dark:bg-blue-500 dark:hover:bg-blue-600 focus:outline-none dark:focus:ring-blue-800">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5 inline mr-1">
                            <path fill-rule="evenodd" d="M12 3.75a.75.75 0 01.75.75v6.75h6.75a.75.75 0 010 1.5h-6.75v6.75a.75.75 0 01-1.5 0v-6.75H4.5a.75.75 0 010-1.5h6.75V4.5a.75.75 0 01.75-.75z" clip-rule="evenodd" />
                        </svg>
                        Agregar
                    </button>
                </div>

                <!-- Botón para crear nuevo vehículo -->
                <button type="button" onclick="openQuickCreateVehiculoModal()" id="add-vehiculo-btn"
                        class="w-full md:w-auto mb-3 px-4 py-2 text-white bg-purple-600 rounded-lg hover:bg-purple-700 focus:ring-4 focus:outline-none focus:ring-purple-300 dark:bg-purple-500 dark:hover:bg-purple-600 text-sm flex items-center justify-center gap-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                    </svg>
                    Nuevo Vehículo
                </button>
            </div>

            <span id="vehiculos-error" class="text-red-600 text-xs hidden">Debe seleccionar al menos 1 vehículo</span>

            <!-- Vehículos Seleccionados -->
            <div id="vehiculos-seleccionados-container" class="hidden mt-4">
                <label class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Vehículos Seleccionados</label>
                <div id="vehiculos-seleccionados-list" class="bg-gray-50 border border-gray-300 rounded-lg p-3 dark:bg-gray-700 dark:border-gray-600">
                    <!-- Lista de vehículos seleccionados -->
                </div>
            </div>
        </div>
    </div>

    <div class="flex justify-end m-4 gap-2">
        <button type="submit" id="submit-button" class="text-white inline-flex items-center bg-green-600 rounded-lg hover:bg-green-700 focus:ring-4 focus:outline-none focus:ring-green-300 dark:bg-green-500 dark:hover:bg-green-600 dark:focus:ring-green-900 font-medium rounded-lg text-sm px-2 py-1 text-center">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-8 text-white-500 dark:text-white-400">
                <path fill-rule="evenodd" d="M2.25 12c0-5.385 4.365-9.75 9.75-9.75s9.75 4.365 9.75 9.75-4.365 9.75-9.75 9.75S2.25 17.385 2.25 12Zm13.36-1.814a.75.75 0 1 0-1.22-.872l-3.236 4.53L9.53 12.22a.75.75 0 0 0-1.06 1.06l2.25 2.25a.75.75 0 0 0 1.14-.094l3.75-5.25Z" clip-rule="evenodd" />
            </svg>
            @submitText
        </button>
        <button type="button" id="clear-button" class="text-white inline-flex items-center bg-red-600 rounded-lg hover:bg-red-700 focus:ring-4 focus:outline-none focus:ring-red-300 dark:bg-red-500 dark:hover:bg-red-600 dark:focus:ring-red-900 font-medium rounded-lg text-sm px-2 py-1 text-center" onclick="@(edit ? "loadClienteForm(null)" : "document.getElementById('cliente-form').reset()")">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-10 h-8 text-white-500 dark:text-white-400">
                <path fill-rule="evenodd" d="M12 2.25c-5.385 0-9.75 4.365-9.75 9.75s4.365 9.75 9.75 9.75 9.75-4.365 9.75-9.75S17.385 2.25 12 2.25Zm-1.72 6.97a.75.75 0 1 0-1.06 1.06L10.94 12l-1.72 1.72a.75.75 0 1 0 1.06 1.06L12 13.06l1.72 1.72a.75.75 0 1 0 1.06-1.06L13.06 12l1.72-1.72a.75.75 0 1 0-1.06-1.06L12 10.94l-1.72-1.72Z" clip-rule="evenodd" />
            </svg>
            @clearText
        </button>
    </div>
    <div id="cliente-validation-summary" asp-validation-summary="All" class="hidden p-4 mt-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400"></div>
    <div id="ajax-form-messages" class="mb-4"></div>
</form>
