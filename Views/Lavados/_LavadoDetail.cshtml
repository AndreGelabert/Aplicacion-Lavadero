@model Firebase.Models.Lavado
@{
    var config = ViewBag.Configuracion as Firebase.Models.Configuracion;
    var tiempoNotificacion = config?.TiempoNotificacionMinutos ?? 15;
    var tiempoTolerancia = config?.TiempoToleranciaMinutos ?? 15;
}

<div class="grid gap-4 md:grid-cols-2">
    <!-- Información General -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Información General</h4>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Cliente:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.ClienteNombre</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Vehículo:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.VehiculoPatente (@Model.TipoVehiculo)</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Estado:</span>
                @if (Model.Estado == "EnProceso")
                {
                    <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">En Proceso</span>
                }
                else if (Model.Estado == "Realizado")
                {
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Realizado</span>
                }
                else if (Model.Estado == "RealizadoParcialmente")
                {
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-yellow-900 dark:text-yellow-300">Realizado Parcialmente</span>
                }
                else if (Model.Estado == "Cancelado")
                {
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-300">Cancelado</span>
                }
                else
                {
                    <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-gray-900 dark:text-gray-300">Pendiente</span>
                }
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Fecha Creación:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.FechaCreacion.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
            </div>
            @if (Model.TiempoInicio.HasValue)
            {
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Inicio:</span>
                    <span class="font-medium text-gray-900 dark:text-white">@Model.TiempoInicio.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                </div>
            }
            @if (Model.TiempoFinalizacion.HasValue)
            {
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Finalización:</span>
                    <span class="font-medium text-gray-900 dark:text-white">@Model.TiempoFinalizacion.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
                </div>
            }
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Tiempo Estimado:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.TiempoEstimado min</span>
            </div>
            @if (!string.IsNullOrEmpty(Model.MotivoCancelacion))
            {
                <div class="mt-2 p-2 bg-red-50 dark:bg-red-900/30 rounded">
                    <span class="text-red-600 dark:text-red-400 text-xs font-medium">Motivo cancelación:</span>
                    <p class="text-red-700 dark:text-red-300 text-sm">@Model.MotivoCancelacion</p>
                </div>
            }
        </div>
    </div>

    <!-- Información de Pago -->
    <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
        <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Información de Pago</h4>
        <div class="space-y-2 text-sm">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Precio Original:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.PrecioOriginal.ToString("C")</span>
            </div>
            @if (Model.Descuento > 0)
            {
                <div class="flex justify-between">
                    <span class="text-gray-600 dark:text-gray-400">Descuento:</span>
                    <span class="font-medium text-green-600 dark:text-green-400">-@Model.Descuento%</span>
                </div>
            }
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Precio Final:</span>
                <span class="font-bold text-lg text-gray-900 dark:text-white">@Model.Precio.ToString("C")</span>
            </div>
            <hr class="border-gray-300 dark:border-gray-600 my-2">
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Monto Pagado:</span>
                <span class="font-medium text-green-600 dark:text-green-400">@((Model.Pago?.MontoPagado ?? 0).ToString("C"))</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Restante:</span>
                <span class="font-medium text-red-600 dark:text-red-400">@((Model.Precio - (Model.Pago?.MontoPagado ?? 0)).ToString("C"))</span>
            </div>
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Estado Pago:</span>
                @{
                    var estadoPago = Model.Pago?.Estado ?? "Pendiente";
                }
                @if (estadoPago == "Pagado")
                {
                    <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Pagado</span>
                }
                else if (estadoPago == "Parcial")
                {
                    <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-yellow-900 dark:text-yellow-300">Parcial</span>
                }
                else
                {
                    <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-300">Pendiente</span>
                }
            </div>
        </div>
        
        @if (Model.Pago?.Pagos != null && Model.Pago.Pagos.Any())
        {
            <div class="mt-4">
                <h5 class="text-sm font-medium text-gray-900 dark:text-white mb-2">Historial de Pagos</h5>
                <div class="space-y-2 max-h-32 overflow-y-auto">
                    @foreach (var pago in Model.Pago.Pagos.OrderByDescending(p => p.Fecha))
                    {
                        <div class="p-2 bg-white dark:bg-gray-600 rounded text-xs">
                            <div class="flex justify-between">
                                <span>@pago.Fecha.ToLocalTime().ToString("dd/MM HH:mm")</span>
                                <span class="font-medium">@pago.Monto.ToString("C")</span>
                            </div>
                            <div class="text-gray-500 dark:text-gray-400">@pago.MedioPago</div>
                            @if (!string.IsNullOrEmpty(pago.Notas))
                            {
                                <div class="text-gray-400 dark:text-gray-500 italic">@pago.Notas</div>
                            }
                        </div>
                    }
                </div>
            </div>
        }
    </div>
</div>

<!-- Empleados Asignados -->
<div class="mt-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
    <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Empleados Asignados (@Model.EmpleadosAsignadosNombres.Count)</h4>
    <div class="flex flex-wrap gap-2">
        @foreach (var nombre in Model.EmpleadosAsignadosNombres)
        {
            <span class="bg-blue-100 text-blue-800 text-sm font-medium px-3 py-1 rounded-full dark:bg-blue-900 dark:text-blue-300">
                @nombre
            </span>
        }
    </div>
</div>

<!-- Retiro del Vehículo -->
<div class="mt-4 bg-gray-50 dark:bg-gray-700 p-4 rounded-lg">
    <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Retiro del Vehículo</h4>
    <div class="space-y-2 text-sm">
        @if (!string.IsNullOrEmpty(Model.ClienteTrajoNombre))
        {
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Trajo el vehículo:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.ClienteTrajoNombre</span>
            </div>
        }
        @if (!string.IsNullOrEmpty(Model.ClienteRetiraNombre))
        {
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Retira el vehículo:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.ClienteRetiraNombre</span>
            </div>
        }
        <div class="flex justify-between items-center">
            <span class="text-gray-600 dark:text-gray-400">Estado de retiro:</span>
            @{
                var estadoRetiro = Model.EstadoRetiro ?? "Pendiente";
            }
            @if (estadoRetiro == "Retirado")
            {
                <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Retirado</span>
            }
            else
            {
                <span class="bg-yellow-100 text-yellow-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-yellow-900 dark:text-yellow-300">Pendiente</span>
            }
        </div>
        @if (Model.FechaRetiro.HasValue)
        {
            <div class="flex justify-between">
                <span class="text-gray-600 dark:text-gray-400">Fecha de retiro:</span>
                <span class="font-medium text-gray-900 dark:text-white">@Model.FechaRetiro.Value.ToLocalTime().ToString("dd/MM/yyyy HH:mm")</span>
            </div>
        }
        @{
            var estadoPagoRetiro = Model.Pago?.Estado ?? "Pendiente";
            var puedeRetirar = (estadoPagoRetiro == "Pagado" || Model.Estado == "Cancelado") && estadoRetiro != "Retirado";
        }
        @if (puedeRetirar)
        {
            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                <button onclick="registrarRetiro('@Model.Id')" 
                        class="inline-flex items-center px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg focus:ring-4 focus:ring-purple-300 dark:focus:ring-purple-900">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    Marcar como Retirado
                </button>
                <p class="mt-2 text-xs text-gray-500 dark:text-gray-400">
                    Verifique que la persona que retira el vehículo sea: <strong>@(Model.ClienteRetiraNombre ?? Model.ClienteNombre)</strong>
                </p>
            </div>
        }
        else if (estadoRetiro != "Retirado")
        {
            <div class="mt-4 pt-3 border-t border-gray-200 dark:border-gray-600">
                <p class="text-xs text-yellow-600 dark:text-yellow-400">
                    <svg class="w-4 h-4 inline mr-1" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
                    </svg>
                    El lavado debe estar pagado para permitir el retiro del vehículo.
                </p>
            </div>
        }
    </div>
</div>

<!-- Servicios -->
<div class="mt-4">
    <h4 class="text-md font-semibold text-gray-900 dark:text-white mb-3">Servicios (@Model.Servicios.Count)</h4>
    <div class="space-y-3">
        @foreach (var servicio in Model.Servicios.OrderBy(s => s.Orden))
        {
            <div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-lg border-l-4 @(servicio.Estado == "Realizado" ? "border-green-500" : servicio.Estado == "EnProceso" ? "border-blue-500" : servicio.Estado == "Cancelado" ? "border-red-500" : "border-gray-300")">
                <div class="flex justify-between items-start">
                    <div>
                        <h5 class="font-medium text-gray-900 dark:text-white">@servicio.ServicioNombre</h5>
                        <p class="text-sm text-gray-500 dark:text-gray-400">
                            @servicio.TipoServicio • @servicio.TiempoEstimado min • @servicio.Precio.ToString("C")
                        </p>
                        @if (!string.IsNullOrEmpty(servicio.PaqueteNombre))
                        {
                            <p class="text-xs text-blue-600 dark:text-blue-400">Paquete: @servicio.PaqueteNombre</p>
                        }
                    </div>
                    <div class="flex items-center gap-2">
                        @if (servicio.Estado == "Realizado")
                        {
                            <span class="bg-green-100 text-green-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-green-900 dark:text-green-300">Realizado</span>
                        }
                        else if (servicio.Estado == "EnProceso")
                        {
                            <span class="bg-blue-100 text-blue-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-blue-900 dark:text-blue-300">En Proceso</span>
                        }
                        else if (servicio.Estado == "Cancelado")
                        {
                            <span class="bg-red-100 text-red-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-red-900 dark:text-red-300">Cancelado</span>
                        }
                        else
                        {
                            <span class="bg-gray-100 text-gray-800 text-xs font-medium px-2.5 py-0.5 rounded dark:bg-gray-900 dark:text-gray-300">Pendiente</span>
                        }
                        
                        @if (Model.Estado == "EnProceso" && (servicio.Estado == "Pendiente" || servicio.Estado == "EnProceso"))
                        {
                            @if (servicio.Estado == "Pendiente")
                            {
                                <button type="button" onclick="iniciarServicioDesdeDetalle('@Model.Id', '@servicio.ServicioId')"
                                        class="p-1 text-blue-600 hover:text-blue-800 dark:text-blue-400" title="Iniciar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                            }
                            @if (servicio.Estado == "EnProceso" && !servicio.Etapas.Any())
                            {
                                <button type="button" onclick="abrirModalFinalizar('@Model.Id', '@servicio.ServicioId', null, 'servicio', '@servicio.ServicioNombre')"
                                        class="p-1 text-green-600 hover:text-green-800 dark:text-green-400" title="Finalizar">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                </button>
                            }
                            <button type="button" onclick="abrirModalCancelar('@Model.Id', '@servicio.ServicioId', null, 'servicio')"
                                    class="p-1 text-red-600 hover:text-red-800 dark:text-red-400" title="Cancelar">
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        }
                    </div>
                </div>
                
                @if (!string.IsNullOrEmpty(servicio.MotivoCancelacion))
                {
                    <div class="mt-2 p-2 bg-red-50 dark:bg-red-900/30 rounded text-xs">
                        <span class="text-red-600 dark:text-red-400 font-medium">Motivo:</span>
                        <span class="text-red-700 dark:text-red-300">@servicio.MotivoCancelacion</span>
                    </div>
                }
                
                <!-- Etapas -->
                @if (servicio.Etapas.Any())
                {
                    <div class="mt-3 pl-4 border-l-2 border-gray-200 dark:border-gray-600">
                        <h6 class="text-xs font-medium text-gray-600 dark:text-gray-400 mb-2">Etapas:</h6>
                        <div class="space-y-2">
                            @foreach (var etapa in servicio.Etapas)
                            {
                                <div class="flex justify-between items-center p-2 bg-white dark:bg-gray-600 rounded">
                                    <div class="flex items-center gap-2">
                                        @if (etapa.Estado == "Realizado")
                                        {
                                            <svg class="w-4 h-4 text-green-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                                            </svg>
                                        }
                                        else if (etapa.Estado == "EnProceso")
                                        {
                                            <svg class="w-4 h-4 text-blue-500 animate-pulse" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                            </svg>
                                        }
                                        else if (etapa.Estado == "Cancelado")
                                        {
                                            <svg class="w-4 h-4 text-red-500" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg class="w-4 h-4 text-gray-400" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.415-1.415L11 9.586V6z" clip-rule="evenodd"></path>
                                            </svg>
                                        }
                                        <span class="text-sm text-gray-900 dark:text-white">@etapa.Nombre</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        @if (etapa.Estado == "Realizado")
                                        {
                                            <span class="text-xs text-green-600 dark:text-green-400">Completada</span>
                                        }
                                        else if (etapa.Estado == "EnProceso")
                                        {
                                            <span class="text-xs text-blue-600 dark:text-blue-400">En Proceso</span>
                                        }
                                        else if (etapa.Estado == "Cancelado")
                                        {
                                            <span class="text-xs text-red-600 dark:text-red-400">Cancelada</span>
                                        }
                                        else
                                        {
                                            <span class="text-xs text-gray-500 dark:text-gray-400">Pendiente</span>
                                        }
                                        
                                        @if (Model.Estado == "EnProceso" && servicio.Estado == "EnProceso" && (etapa.Estado == "Pendiente" || etapa.Estado == "EnProceso"))
                                        {
                                            @if (etapa.Estado == "Pendiente")
                                            {
                                                <button type="button" onclick="iniciarEtapaDesdeDetalle('@Model.Id', '@servicio.ServicioId', '@etapa.EtapaId')"
                                                        class="p-1 text-blue-600 hover:text-blue-800" title="Iniciar">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z"></path>
                                                    </svg>
                                                </button>
                                            }
                                            @if (etapa.Estado == "EnProceso")
                                            {
                                                <button type="button" onclick="abrirModalFinalizar('@Model.Id', '@servicio.ServicioId', '@etapa.EtapaId', 'etapa', '@etapa.Nombre')"
                                                        class="p-1 text-green-600 hover:text-green-800" title="Finalizar">
                                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                                    </svg>
                                                </button>
                                            }
                                            <button type="button" onclick="abrirModalCancelar('@Model.Id', '@servicio.ServicioId', '@etapa.EtapaId', 'etapa')"
                                                    class="p-1 text-red-600 hover:text-red-800" title="Cancelar">
                                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                                </svg>
                                            </button>
                                        }
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                }
            </div>
        }
    </div>
</div>

<!-- Botón de Finalizar Lavado (solo si todos los servicios están finalizados) -->
@if (Model.Estado == "EnProceso")
{
    var todosServiciosFinalizados = Model.Servicios.All(s => s.Estado == "Realizado" || s.Estado == "Cancelado");
    @if (todosServiciosFinalizados)
    {
        <div class="mt-4 flex justify-end">
            <button type="button" onclick="abrirModalFinalizar('@Model.Id', null, null, 'lavado', '')"
                    class="px-4 py-2 text-sm font-medium text-white bg-blue-600 rounded-lg hover:bg-blue-700">
                Finalizar Lavado
            </button>
        </div>
    }
}

@if (!string.IsNullOrEmpty(Model.Notas))
{
    <div class="mt-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
        <h4 class="text-sm font-semibold text-gray-900 dark:text-white mb-2">Notas</h4>
        <p class="text-sm text-gray-600 dark:text-gray-400">@Model.Notas</p>
    </div>
}
